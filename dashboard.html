/**
 * ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô dashboard.html ‡∏™‡πà‡∏ß‡∏ô <script>
 * ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ localStorage ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÅ‡∏ó‡∏ô Auth.getUser()
 */

const Dashboard = {
  data: {
    user: null,
    summary: {
      monthlyIncome: 0,
      monthlyExpense: 0,
      monthlyProfit: 0,
      lastMonthProfit: 0,
      productCount: 0,
      transactionCount: 0
    },
    transactions: [],
    news: []
  },

  async init() {
    // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ localStorage ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
    const userStr = localStorage.getItem('surat_otop_user');
    if (!userStr) {
      console.error('No user in localStorage');
      window.location.href = 'index.html';
      return;
    }

    try {
      this.data.user = JSON.parse(userStr);
      console.log('‚úÖ User loaded:', this.data.user);
      console.log('‚úÖ User ID:', this.data.user.userId);
    } catch (error) {
      console.error('Parse user error:', error);
      window.location.href = 'index.html';
      return;
    }

    this.renderUserInfo();
    await this.loadData();
  },

  renderUserInfo() {
    const user = this.data.user;
    if (user) {
      const nameEl = document.getElementById('user-name');
      if (nameEl) {
        nameEl.textContent = user.chairmanOwnerName || user.entrepreneursName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
      }
    }
  },

  async loadData() {
    try {
      await Promise.all([
        this.loadSummary(),
        this.loadTransactions(),
        this.loadNews()
      ]);
    } catch (error) {
      console.error('Load data error:', error);
    }
  },

  async loadSummary() {
    try {
      const user = this.data.user;
      
      console.log('üìä Loading summary for userId:', user.userId);
      const result = await API.getDashboardData(user.userId);
      console.log('üìä Summary result:', result);
      
      if (result.success && result.data) {
        this.data.summary = {
          monthlyIncome: result.data.monthlyIncome || 0,
          monthlyExpense: result.data.monthlyExpense || 0,
          productCount: result.data.productCount || 0,
          transactionCount: result.data.transactionCount || 0,
          lastMonthProfit: 0
        };
      } else {
        console.error('Load summary failed:', result.error);
        this.data.summary = {
          monthlyIncome: 0,
          monthlyExpense: 0,
          productCount: 0,
          transactionCount: 0,
          lastMonthProfit: 0
        };
      }
      
      this.renderSummary();
    } catch (error) {
      console.error('Load summary error:', error);
      this.renderSummary();
    }
  },

  renderSummary() {
    const summary = this.data.summary;
    const profit = summary.monthlyIncome - summary.monthlyExpense;
    
    const profitEl = document.getElementById('monthly-profit-value');
    if (profitEl) {
      profitEl.textContent = '‡∏ø' + profit.toLocaleString('th-TH');
    }
    
    const lastMonthProfit = summary.lastMonthProfit || 0;
    let percentChange = 0;
    let isIncrease = true;
    
    if (lastMonthProfit > 0) {
      percentChange = ((profit - lastMonthProfit) / lastMonthProfit) * 100;
      isIncrease = percentChange >= 0;
    } else if (profit > 0) {
      percentChange = 100;
    }
    
    const percentElement = document.getElementById('profit-percentage');
    if (percentElement) {
      percentElement.innerHTML = `
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="${isIncrease ? 'M13 7h8m0 0v8m0-8l-8 8-4-4-6 6' : 'M13 17h8m0 0v-8m0 8l-8-8-4 4-6-6'}"></path>
        </svg>
        <span>${isIncrease ? '+' : ''}${percentChange.toFixed(1)}%</span>
        <span class="ml-2 text-emerald-100">‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</span>
      `;
    }
    
    const productEl = document.getElementById('product-count-value');
    if (productEl) {
      productEl.textContent = summary.productCount.toLocaleString('th-TH');
    }
    
    const txCountEl = document.getElementById('transaction-count-value');
    if (txCountEl) {
      txCountEl.textContent = summary.transactionCount.toLocaleString('th-TH');
    }
    
    const incomeEl = document.getElementById('monthly-income-value');
    if (incomeEl) {
      incomeEl.textContent = '‡∏ø' + summary.monthlyIncome.toLocaleString('th-TH');
    }
    
    const expenseEl = document.getElementById('monthly-expense-value');
    if (expenseEl) {
      expenseEl.textContent = '‡∏ø' + summary.monthlyExpense.toLocaleString('th-TH');
    }
  },

  async loadTransactions() {
    try {
      const user = this.data.user;
      
      console.log('üìù Loading transactions for userId:', user.userId);
      const result = await API.getTransactions(user.userId, 10);
      console.log('üìù Transactions result:', result);
      
      if (result.success && result.data) {
        this.data.transactions = result.data;
        console.log('‚úÖ Loaded', this.data.transactions.length, 'transactions');
      } else {
        console.error('Load transactions failed:', result.error);
        this.data.transactions = [];
      }
      
      this.renderTransactions();
    } catch (error) {
      console.error('Load transactions error:', error);
      this.data.transactions = [];
      this.renderTransactions();
    }
  },

  renderTransactions() {
    const container = document.getElementById('recent-transactions');
    if (!container) {
      console.error('Container #recent-transactions not found');
      return;
    }
    
    const transactions = this.data.transactions;
    
    console.log('üñºÔ∏è Rendering', transactions?.length || 0, 'transactions');
    
    if (!transactions || transactions.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8 text-gray-400">
          <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p class="mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
          <p class="text-xs">User ID: ${this.data.user?.userId || 'N/A'}</p>
          <a href="accounting.html" class="mt-2 inline-block text-emerald-600 hover:text-emerald-700 text-sm">
            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Üí
          </a>
        </div>
      `;
      return;
    }
    
    container.innerHTML = transactions.map(tx => {
      const isIncome = tx.type === 'income';
      const amount = parseFloat(tx.amount) || 0;
      const date = tx.date ? new Date(tx.date) : new Date();
      
      return `
        <div class="flex items-center justify-between p-4 hover:bg-gray-50 rounded-lg transition border-b border-gray-100">
          <div class="flex items-center flex-1">
            <div class="w-10 h-10 rounded-lg flex items-center justify-center mr-3 ${
              isIncome ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'
            }">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                ${isIncome 
                  ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path>'
                  : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"></path>'
                }
              </svg>
            </div>
            <div class="flex-1">
              <div class="font-medium text-gray-800">${tx.description || tx.category || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</div>
              <div class="text-sm text-gray-500">
                ${tx.category || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'} ‚Ä¢ ${date.toLocaleDateString('th-TH')}
              </div>
            </div>
          </div>
          <div class="text-right">
            <div class="font-bold ${isIncome ? 'text-emerald-600' : 'text-red-600'}">
              ${isIncome ? '+' : '-'}‡∏ø${amount.toLocaleString('th-TH')}
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    console.log('‚úÖ Rendered', transactions.length, 'transactions');
  },

  async loadNews() {
    try {
      const result = await API.getActiveNews();
      if (result.success && result.data) {
        this.data.news = result.data;
      } else {
        this.data.news = [];
      }
      this.renderNews();
    } catch (error) {
      console.error('Load news error:', error);
      this.data.news = [];
      this.renderNews();
    }
  },

  renderNews() {
    const container = document.getElementById('news-marquee');
    if (!container) return;
    
    const news = this.data.news;
    
    if (!news || news.length === 0) {
      container.innerHTML = 'üì¢ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®';
      container.classList.remove('marquee');
      return;
    }
    
    const newsText = news.map(n => `üì¢ ${n.title}: ${n.content}`).join('  ‚Ä¢  ');
    container.innerHTML = newsText;
    container.classList.add('marquee');
  },

  async refresh() {
    await this.loadData();
    console.log('‚úÖ Data refreshed');
  },

  showQuickMenu() {
    const modal = document.getElementById('quick-menu-modal');
    if (modal) {
      modal.classList.remove('hidden');
    }
  },

  closeQuickMenu() {
    const modal = document.getElementById('quick-menu-modal');
    if (modal) {
      modal.classList.add('hidden');
    }
  },

  logout() {
    localStorage.removeItem('surat_otop_user');
    localStorage.removeItem('surat_otop_token');
    window.location.href = 'index.html';
  }
};

// ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
document.addEventListener('DOMContentLoaded', () => {
  console.log('üöÄ Dashboard initializing...');
  Dashboard.init();
});