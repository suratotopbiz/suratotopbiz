<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ - Surat OTOP Biz</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Prompt', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <a href="dashboard.html" class="mr-4 p-2 hover:bg-white hover:bg-opacity-20 rounded-lg transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </a>
                    <div>
                        <h1 class="text-xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>
                        <p class="text-sm text-blue-100">Accounting</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8 max-w-6xl mb-20">
        
        <!-- Quick Add Form -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
            </h2>
            
            <form id="transaction-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó <span class="text-red-500">*</span>
                        </label>
                        <select id="type" onchange="updateCategories()" 
                                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                required>
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                            <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                            <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                        </select>
                    </div>

                    <!-- ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà <span class="text-red-500">*</span>
                        </label>
                        <select id="category" 
                                class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                required disabled>
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                        </select>
                    </div>

                    <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó) <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-gray-500">‡∏ø</span>
                            <input type="number" id="amount" 
                                   placeholder="0.00" 
                                   step="0.01" 
                                   min="0.01"
                                   class="w-full pl-8 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                   required>
                        </div>
                    </div>

                    <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span class="text-red-500">*</span>
                        </label>
                        <input type="date" id="date" 
                               class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                               required>
                    </div>
                </div>

                <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    </label>
                    <input type="text" id="description" 
                           placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..." 
                           class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>

                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
                <div class="flex gap-3">
                    <button type="submit" 
                            class="flex-1 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-semibold py-3 rounded-xl transition duration-300 shadow-lg hover:shadow-xl flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </button>
                    <button type="button" onclick="clearForm()" 
                            class="px-6 py-3 border-2 border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition">
                        ‡∏•‡πâ‡∏≤‡∏á
                    </button>
                </div>
            </form>
        </div>

        <!-- Summary -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-emerald-50 p-4 rounded-xl text-center">
                <div class="text-sm text-emerald-700">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>
                <div class="text-2xl font-bold text-emerald-600" id="total-income">‡∏ø0</div>
            </div>
            <div class="bg-red-50 p-4 rounded-xl text-center">
                <div class="text-sm text-red-700">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
                <div class="text-2xl font-bold text-red-600" id="total-expense">‡∏ø0</div>
            </div>
            <div class="bg-blue-50 p-4 rounded-xl text-center">
                <div class="text-sm text-blue-700">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</div>
                <div class="text-2xl font-bold text-blue-600" id="total-profit">‡∏ø0</div>
            </div>
            <div class="bg-gray-50 p-4 rounded-xl text-center">
                <div class="text-sm text-gray-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                <div class="text-2xl font-bold text-gray-600" id="total-count">0</div>
            </div>
        </div>

        <!-- Transactions List -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <button onclick="loadTransactions()" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                    üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                </button>
            </div>
            
            <div id="transactions-list" class="space-y-3">
                <div class="text-center py-12 text-gray-400">
                    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    
    <script>
        // ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
        const categories = {
            income: ['‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'],
            expense: ['‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö', '‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ']
        };

        let allTransactions = [];

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
        function updateCategories() {
            const type = document.getElementById('type').value;
            const categorySelect = document.getElementById('category');
            
            categorySelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>';
            
            if (!type) {
                categorySelect.disabled = true;
                return;
            }
            
            categories[type].forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
            
            categorySelect.disabled = false;
        }

        // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
        function clearForm() {
            document.getElementById('transaction-form').reset();
            document.getElementById('category').disabled = true;
            document.getElementById('category').innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>';
            document.getElementById('date').valueAsDate = new Date();
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        document.getElementById('transaction-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const type = document.getElementById('type').value;
            const category = document.getElementById('category').value;
            const amount = document.getElementById('amount').value;
            const description = document.getElementById('description').value;
            const date = document.getElementById('date').value;
            
            // Validation
            if (!type || !category) {
                alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà');
                return;
            }
            
            if (!amount || parseFloat(amount) <= 0) {
                alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            
            if (!date) {
                alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
                return;
            }
            
            const user = Auth.getCurrentUser();
            if (!user || !user.userId) {
                alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡πÉ‡∏´‡∏°‡πà');
                window.location.href = 'index.html';
                return;
            }
            
            const data = {
                userId: user.userId,
                type: type,
                category: category,
                amount: parseFloat(amount),
                description: description || '-',
                date: date
            };
            
            try {
                const result = await API.addTransaction(data);
                
                if (result.success) {
                    alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    clearForm();
                    loadTransactions();
                } else {
                    alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'));
                }
            } catch (error) {
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        });

        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        async function loadTransactions() {
            const user = Auth.getCurrentUser();
            if (!user || !user.userId) return;
            
            try {
                const result = await API.getTransactions(user.userId, 50);
                
                if (result.success) {
                    allTransactions = result.data || [];
                    renderTransactions(allTransactions);
                    updateSummary(allTransactions);
                }
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        function renderTransactions(transactions) {
            const container = document.getElementById('transactions-list');
            
            if (!transactions || transactions.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-400"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p></div>';
                return;
            }
            
            container.innerHTML = transactions.map(tx => {
                const isIncome = tx.type === 'income';
                const amount = parseFloat(tx.amount) || 0;
                const date = new Date(tx.date);
                
                return `
                    <div class="flex items-center justify-between p-4 hover:bg-gray-50 rounded-xl transition border-b border-gray-100">
                        <div class="flex items-center flex-1">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center mr-4 ${
                                isIncome ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'
                            }">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    ${isIncome 
                                        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path>'
                                        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"></path>'
                                    }
                                </svg>
                            </div>
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800">${tx.category}</div>
                                <div class="text-sm text-gray-500">${tx.description || '-'} ‚Ä¢ ${date.toLocaleDateString('th-TH')}</div>
                            </div>
                        </div>
                        <div class="text-right ml-4">
                            <div class="text-xl font-bold ${isIncome ? 'text-emerald-600' : 'text-red-600'}">
                                ${isIncome ? '+' : '-'}‡∏ø${amount.toLocaleString('th-TH', {minimumFractionDigits: 2})}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ
        function updateSummary(transactions) {
            let totalIncome = 0;
            let totalExpense = 0;
            
            transactions.forEach(tx => {
                const amount = parseFloat(tx.amount) || 0;
                if (tx.type === 'income') totalIncome += amount;
                else totalExpense += amount;
            });
            
            document.getElementById('total-income').textContent = '‡∏ø' + totalIncome.toLocaleString('th-TH');
            document.getElementById('total-expense').textContent = '‡∏ø' + totalExpense.toLocaleString('th-TH');
            document.getElementById('total-profit').textContent = '‡∏ø' + (totalIncome - totalExpense).toLocaleString('th-TH');
            document.getElementById('total-count').textContent = transactions.length;
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.isLoggedIn()) {
                window.location.href = 'index.html';
                return;
            }
            
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('category').disabled = true;
            
            loadTransactions();
        });
    </script>
</body>
</html>